local GuiModule = {}

-- Сервисы
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local player = Players.LocalPlayer

local DEFAULT_SETTINGS = {
	MainColor = Color3.fromRGB(18, 18, 22),
	SecondaryColor = Color3.fromRGB(28, 28, 32),
	AccentColor = Color3.fromRGB(0, 160, 255),
	TextColor = Color3.fromRGB(255, 255, 255),
	ButtonColor = Color3.fromRGB(45, 45, 50),
	ButtonHoverColor = Color3.fromRGB(60, 60, 65),
	Font = Enum.Font.GothamMedium,
	TextSize = 14,
	CornerRadius = UDim.new(0, 10),
	Width = 550,
	Height = 350,
}

function GuiModule.new(settings)
	settings = settings or {}
	for k, v in pairs(DEFAULT_SETTINGS) do
		if settings[k] == nil then settings[k] = v end
	end

	-- Создаем контейнер
	local screenGui = Instance.new("ScreenGui")
	screenGui.Name = "CustomGuiSystem"
	screenGui.ResetOnSpawn = false
	screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
	screenGui.Parent = player:WaitForChild("PlayerGui")

	-- Основной фрейм
	local mainFrame = Instance.new("Frame")
	mainFrame.Size = UDim2.new(0, settings.Width, 0, settings.Height)
	mainFrame.Position = UDim2.new(0.5, -settings.Width/2, 0.5, -settings.Height/2)
	mainFrame.BackgroundColor3 = settings.MainColor
	mainFrame.BorderSizePixel = 0
	mainFrame.Parent = screenGui

	Instance.new("UICorner", mainFrame).CornerRadius = settings.CornerRadius
	local stroke = Instance.new("UIStroke", mainFrame)
	stroke.Thickness = 1.5
	stroke.Color = settings.AccentColor
	stroke.Transparency = 0.6

	-- Левая панель (Зона для перетаскивания)
	local leftPanel = Instance.new("Frame")
	leftPanel.Size = UDim2.new(0, 160, 1, 0)
	leftPanel.BackgroundColor3 = settings.SecondaryColor
	leftPanel.BorderSizePixel = 0
	leftPanel.Parent = mainFrame
	Instance.new("UICorner", leftPanel).CornerRadius = settings.CornerRadius

	local tabsScrolling = Instance.new("ScrollingFrame")
	tabsScrolling.Size = UDim2.new(1, -10, 1, -20)
	tabsScrolling.Position = UDim2.new(0, 5, 0, 10)
	tabsScrolling.BackgroundTransparency = 1
	tabsScrolling.ScrollBarThickness = 2
	tabsScrolling.CanvasSize = UDim2.new(0, 0, 0, 0)
	tabsScrolling.AutomaticCanvasSize = Enum.AutomaticSize.Y
	tabsScrolling.Parent = leftPanel

	local tabsLayout = Instance.new("UIListLayout", tabsScrolling)
	tabsLayout.Padding = UDim.new(0, 5)
	tabsLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center

	-- Правая панель
	local rightPanel = Instance.new("Frame")
	rightPanel.Size = UDim2.new(1, -160, 1, 0)
	rightPanel.Position = UDim2.new(0, 160, 0, 0)
	rightPanel.BackgroundTransparency = 1
	rightPanel.Parent = mainFrame

	local funcScrolling = Instance.new("ScrollingFrame")
	funcScrolling.Size = UDim2.new(1, -10, 1, -20)
	funcScrolling.Position = UDim2.new(0, 5, 0, 10)
	funcScrolling.BackgroundTransparency = 1
	funcScrolling.ScrollBarThickness = 2
	funcScrolling.AutomaticCanvasSize = Enum.AutomaticSize.Y
	funcScrolling.Parent = rightPanel

	local funcLayout = Instance.new("UIListLayout", funcScrolling)
	funcLayout.Padding = UDim.new(0, 8)
	funcLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center

	local tabsData = {}
	local currentTab = nil

	-- Логика переключения
	local function updateDisplay()
		for _, child in pairs(funcScrolling:GetChildren()) do
			if child:IsA("Frame") then child.Visible = false end
		end
		if currentTab and tabsData[currentTab] then
			for _, item in pairs(tabsData[currentTab].items) do
				item.Visible = true
			end
		end
	end

	-- Метод создания вкладки
	function mainFrame:CreateTab(tabName)
		local tabBtn = Instance.new("TextButton")
		tabBtn.Size = UDim2.new(1, -10, 0, 35)
		tabBtn.BackgroundColor3 = settings.ButtonColor
		tabBtn.Text = tabName
		tabBtn.TextColor3 = settings.TextColor
		tabBtn.Font = settings.Font
		tabBtn.TextSize = 13
		tabBtn.AutoButtonColor = false
		tabBtn.Parent = tabsScrolling
		Instance.new("UICorner", tabBtn).CornerRadius = UDim.new(0, 6)

		tabsData[tabName] = {button = tabBtn, items = {}}

		tabBtn.MouseButton1Click:Connect(function()
			if currentTab then 
				TweenService:Create(tabsData[currentTab].button, TweenInfo.new(0.2), {BackgroundColor3 = settings.ButtonColor}):Play()
			end
			currentTab = tabName
			TweenService:Create(tabBtn, TweenInfo.new(0.2), {BackgroundColor3 = settings.AccentColor}):Play()
			updateDisplay()
		end)

		if not currentTab then 
			currentTab = tabName
			tabBtn.BackgroundColor3 = settings.AccentColor
		end
		return tabName
	end

	-- Метод добавления функции
	function mainFrame:AddFunction(tabName, funcName, callback)
		local fFrame = Instance.new("Frame")
		fFrame.Size = UDim2.new(1, -10, 0, 40)
		fFrame.BackgroundColor3 = settings.SecondaryColor
		fFrame.Visible = (currentTab == tabName)
		fFrame.Parent = funcScrolling
		Instance.new("UICorner", fFrame).CornerRadius = UDim.new(0, 6)

		local label = Instance.new("TextLabel")
		label.Size = UDim2.new(0.7, 0, 1, 0)
		label.Position = UDim2.new(0, 10, 0, 0)
		label.Text = funcName
		label.TextColor3 = settings.TextColor
		label.BackgroundTransparency = 1
		label.TextXAlignment = Enum.TextXAlignment.Left
		label.Font = settings.Font
		label.Parent = fFrame

		local btn = Instance.new("TextButton")
		btn.Size = UDim2.new(0.3, -10, 0.7, 0)
		btn.Position = UDim2.new(0.7, 5, 0.15, 0)
		btn.BackgroundColor3 = settings.AccentColor
		btn.Text = "RUN"
		btn.TextColor3 = settings.TextColor
		btn.Font = settings.Font
		btn.Parent = fFrame
		Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 4)

		btn.MouseButton1Click:Connect(function()
			task.spawn(callback)
			btn.Text = "..."
			task.wait(0.2)
			btn.Text = "RUN"
		end)

		table.insert(tabsData[tabName].items, fFrame)
	end

	-- Перетаскивание (только за LeftPanel)
	local dragging, dragInput, dragStart, startPos
	leftPanel.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = true
			dragStart = input.Position
			startPos = mainFrame.Position
		end
	end)

	UserInputService.InputChanged:Connect(function(input)
		if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
			local delta = input.Position - dragStart
			mainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
		end
	end)

	leftPanel.InputEnded:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
	end)

	return mainFrame
end

return GuiModule
