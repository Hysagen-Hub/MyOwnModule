local UI_Module = {}
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")

-- Логика перетаскивания (Drag)
local function MakeDraggable(gui)
	local dragging, dragInput, dragStart, startPos
	gui.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = true
			dragStart = input.Position
			startPos = gui.Position
		end
	end)
	gui.InputEnded:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
	end)
	UserInputService.InputChanged:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseMovement then dragInput = input end
	end)
	game:GetService("RunService").RenderStepped:Connect(function()
		if dragging and dragInput then
			local delta = dragInput.Position - dragStart
			gui.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
		end
	end)
end

function UI_Module.CreateMain(hubTitle)
	-- Мета-таблицы для защиты методов
	local Library = { TabButtons = {} }
	local TabBase = {}
	TabBase.__index = TabBase
	
	local Themes = {
		["Black (Default)"] = {
			Main = Color3.fromRGB(12, 12, 12),
			Sidebar = Color3.fromRGB(18, 18, 18),
			Stroke = Color3.fromRGB(35, 35, 35),
			Accent = Color3.fromRGB(255, 255, 255),
			Text = Color3.fromRGB(255, 255, 255),
			Secondary = Color3.fromRGB(25, 25, 25)
		},
		["Orange Dream"] = {
			Main = Color3.fromRGB(25, 18, 15),
			Sidebar = Color3.fromRGB(35, 25, 20),
			Stroke = Color3.fromRGB(75, 45, 30),
			Accent = Color3.fromRGB(255, 140, 50),
			Text = Color3.fromRGB(255, 230, 210),
			Secondary = Color3.fromRGB(45, 35, 30)
		},
		["Deep Blue"] = {
			Main = Color3.fromRGB(10, 15, 25),
			Sidebar = Color3.fromRGB(15, 20, 35),
			Stroke = Color3.fromRGB(35, 50, 90),
			Accent = Color3.fromRGB(60, 160, 255),
			Text = Color3.fromRGB(210, 235, 255),
			Secondary = Color3.fromRGB(25, 30, 50)
		}
	}
	
	local CurrentTheme = Themes["Black (Default)"]
	local ScreenGui = Instance.new("ScreenGui", Players.LocalPlayer:WaitForChild("PlayerGui"))
	ScreenGui.Name = "Final_Engine_GUI"
	ScreenGui.ResetOnSpawn = false

	local Main = Instance.new("Frame", ScreenGui)
	Main.Name = "MainFrame"
	Main.Size = UDim2.new(0, 630, 0, 430)
	Main.Position = UDim2.new(0.5, -315, 0.5, -215)
	Main.BackgroundColor3 = CurrentTheme.Main
	Main.BorderSizePixel = 0
	Instance.new("UICorner", Main).CornerRadius = UDim.new(0, 10)
	local MainStroke = Instance.new("UIStroke", Main)
	MainStroke.Thickness = 2
	MainStroke.Color = CurrentTheme.Stroke
	
	MakeDraggable(Main) -- Теперь окно можно двигать

	local Sidebar = Instance.new("Frame", Main)
	Sidebar.Name = "Sidebar"
	Sidebar.Size = UDim2.new(0, 175, 1, 0)
	Sidebar.BackgroundColor3 = CurrentTheme.Sidebar
	Sidebar.BorderSizePixel = 0
	Instance.new("UICorner", Sidebar)

	local SidebarScroll = Instance.new("ScrollingFrame", Sidebar)
	SidebarScroll.Size = UDim2.new(1, -10, 1, -70)
	SidebarScroll.Position = UDim2.new(0, 5, 0, 65)
	SidebarScroll.BackgroundTransparency = 1
	SidebarScroll.ScrollBarThickness = 0
	Instance.new("UIListLayout", SidebarScroll).Padding = UDim.new(0, 5)

	local Title = Instance.new("TextLabel", Sidebar)
	Title.Size = UDim2.new(1, 0, 0, 60)
	Title.Text = hubTitle
	Title.TextColor3 = CurrentTheme.Text
	Title.Font = Enum.Font.GothamBold
	Title.TextSize = 16
	Title.BackgroundTransparency = 1

	local PagesFolder = Instance.new("Frame", Main)
	PagesFolder.Size = UDim2.new(1, -195, 1, -20)
	PagesFolder.Position = UDim2.new(0, 185, 0, 10)
	PagesFolder.BackgroundTransparency = 1

	-- Функция глобальной смены гаммы
	local function ApplyTheme(theme)
		CurrentTheme = theme
		local tInfo = TweenInfo.new(0.5)
		for _, obj in pairs(ScreenGui:GetDescendants()) do
			if obj.Name == "MainFrame" then TweenService:Create(obj, tInfo, {BackgroundColor3 = theme.Main}):Play()
			elseif obj.Name == "Sidebar" then TweenService:Create(obj, tInfo, {BackgroundColor3 = theme.Sidebar}):Play()
			elseif obj:IsA("UIStroke") then TweenService:Create(obj, tInfo, {Color = theme.Stroke}):Play()
			elseif obj:IsA("TextLabel") then TweenService:Create(obj, tInfo, {TextColor3 = theme.Text}):Play()
			elseif obj.Name == "Row" or (obj:IsA("TextButton") and not obj:GetAttribute("Active")) then
				TweenService:Create(obj, tInfo, {BackgroundColor3 = theme.Secondary}):Play()
			elseif obj:IsA("TextButton") and obj:GetAttribute("Active") then
				TweenService:Create(obj, tInfo, {BackgroundColor3 = theme.Accent}):Play()
			end
		end
	end

	-- МЕТОДЫ ВКЛАДОК
	function TabBase:AddLabel(text)
		local L = Instance.new("TextLabel", self.Page)
		L.Size = UDim2.new(1, -10, 0, 25)
		L.BackgroundTransparency = 1
		L.Text = text
		L.TextColor3 = CurrentTheme.Text
		L.Font = Enum.Font.Gotham
		L.TextXAlignment = Enum.TextXAlignment.Left
		return L
	end

	function TabBase:AddButtonRow(text, btnText, callback)
		local Row = Instance.new("Frame", self.Page)
		Row.Name = "Row"
		Row.Size = UDim2.new(1, -10, 0, 48)
		Row.BackgroundColor3 = CurrentTheme.Secondary
		Instance.new("UICorner", Row)
		local s = Instance.new("UIStroke", Row)
		s.Color = CurrentTheme.Stroke

		local L = Instance.new("TextLabel", Row)
		L.Size = UDim2.new(0.6, 0, 1, 0)
		L.Position = UDim2.new(0, 15, 0, 0)
		L.Text = text
		L.TextColor3 = CurrentTheme.Text
		L.BackgroundTransparency = 1
		L.TextXAlignment = Enum.TextXAlignment.Left

		local B = Instance.new("TextButton", Row)
		B.Size = UDim2.new(0.3, 0, 0, 32)
		B.Position = UDim2.new(0.65, 0, 0.5, -16)
		B.BackgroundColor3 = CurrentTheme.Accent
		B.Text = btnText
		B.TextColor3 = Color3.new(0,0,0)
		B.Font = Enum.Font.GothamBold
		Instance.new("UICorner", B)
		B.MouseButton1Click:Connect(callback)
		return B
	end

	-- ГЛАВНЫЙ МЕТОД СОЗДАНИЯ ВКЛАДКИ
	function Library:CreateTab(name, isSettings)
		local NewTab = setmetatable({}, TabBase)
		
		local TabBtn = Instance.new("TextButton", SidebarScroll)
		TabBtn.Size = UDim2.new(0.95, 0, 0, 38)
		TabBtn.BackgroundColor3 = CurrentTheme.Secondary
		TabBtn.Text = name
		TabBtn.TextColor3 = CurrentTheme.Text
		TabBtn.Font = Enum.Font.GothamMedium
		TabBtn.LayoutOrder = isSettings and 9999 or #Library.TabButtons
		Instance.new("UICorner", TabBtn).CornerRadius = UDim.new(0, 8)
		table.insert(Library.TabButtons, TabBtn)

		local Page = Instance.new("ScrollingFrame", PagesFolder)
		Page.Name = name.."_Page"
		Page.Size = UDim2.new(1, 0, 1, 0)
		Page.BackgroundTransparency = 1
		Page.Visible = false
		Page.ScrollBarThickness = 2
		Instance.new("UIListLayout", Page).Padding = UDim.new(0, 10)

		NewTab.Page = Page
		NewTab.Button = TabBtn

		TabBtn.MouseButton1Click:Connect(function()
			for _, p in pairs(PagesFolder:GetChildren()) do p.Visible = false end
			for _, b in pairs(Library.TabButtons) do
				b:SetAttribute("Active", false)
				TweenService:Create(b, TweenInfo.new(0.3), {BackgroundColor3 = CurrentTheme.Secondary}):Play()
			end
			Page.Visible = true
			TabBtn:SetAttribute("Active", true)
			TweenService:Create(TabBtn, TweenInfo.new(0.3), {BackgroundColor3 = CurrentTheme.Accent}):Play()
		end)

		if not isSettings and #Library.TabButtons == 1 then
			Page.Visible = true
			TabBtn:SetAttribute("Active", true)
			TabBtn.BackgroundColor3 = CurrentTheme.Accent
		end

		return NewTab
	end

	-- Вшиваем настройки
	local Settings = Library:CreateTab("Settings", true)
	Settings:AddLabel("Select Visual Theme:")
	for name, data in pairs(Themes) do
		Settings:AddButtonRow("Gama: "..name, "Set", function() ApplyTheme(data) end)
	end

	return Library
end

return UI_Module
